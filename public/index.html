<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cartão Fidelidade Virtual</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3b82f6">
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div class="container mx-auto p-4 max-w-md">
    <h1 class="text-2xl font-bold text-center mb-4">Cartão Fidelidade Virtual</h1>

    <!-- Seção do Cliente -->
    <div id="clienteSection" class="bg-white p-6 rounded-lg shadow-md mb-4">
      <h2 class="text-xl font-semibold mb-4">Área do Cliente</h2>
      <p class="text-sm text-gray-600 mb-2">Seus dados serão usados apenas para o programa de fidelidade, conforme a LGPD.</p>
      <input id="clienteId" type="text" placeholder="Digite seu e-mail ou telefone" class="w-full p-2 mb-2 border rounded">
      <label class="flex items-center mb-4">
        <input id="consentimento" type="checkbox" class="mr-2">
        <span class="text-sm">Concordo com o uso dos meus dados para o programa de fidelidade.</span>
      </label>
      <button id="verificarBtn" onclick="verificarPontos()" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Verificar Pontos</button>
      <p id="resultadoCliente" class="mt-4 text-center"></p>
    </div>

    <!-- Seção do Lojista -->
    <div id="lojistaSection" class="bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold mb-4">Área do Lojista</h2>
      <input id="senhaLojista" type="password" placeholder="Digite a senha do lojista" class="w-full p-2 mb-4 border rounded">
      <input id="clienteIdLojista" type="text" placeholder="E-mail ou telefone do cliente" class="w-full p-2 mb-4 border rounded">
      <input id="pontos" type="number" min="1" max="100" placeholder="Quantidade de pontos (1-100)" class="w-full p-2 mb-4 border rounded">
      <button id="adicionarBtn" onclick="adicionarPontos()" class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600 mb-2">Adicionar Pontos</button>
      <button id="resgatarBtn" onclick="resgatarRecompensa()" class="w-full bg-red-500 text-white p-2 rounded hover:bg-red-600">Resgatar Recompensa</button>
      <p id="resultadoLojista" class="mt-4 text-center"></p>
    </div>
  </div>

  <script>
    console.log('Carregando JavaScript do index.html');

    // Sanitizar texto para evitar XSS
    function sanitizarTexto(texto) {
      const div = document.createElement("div");
      div.textContent = texto;
      return div.innerHTML;
    }

    // Função para mostrar estado de carregamento
    function setCarregando(elementId, botaoId, carregando) {
      const elemento = document.getElementById(elementId);
      const botao = document.getElementById(botaoId);
      if (carregando) {
        elemento.innerText = 'Carregando...';
        botao.disabled = true;
      } else {
        elemento.innerText = '';
        botao.disabled = false;
      }
    }

    // Verificar pontos do cliente
    async function verificarPontos() {
      const clienteId = document.getElementById("clienteId").value.trim();
      const consentimento = document.getElementById("consentimento").checked;

      setCarregando('resultadoCliente', 'verificarBtn', true);

      if (!consentimento) {
        setCarregando('resultadoCliente', 'verificarBtn', false);
        document.getElementById("resultadoCliente").innerText = "Você deve concordar com o uso dos dados.";
        return;
      }

      try {
        console.log('Enviando requisição para /verificar-pontos');
        const response = await fetch('/verificar-pontos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ clienteId, consentimento })
        });
        const data = await response.json();
        console.log('Resposta de /verificar-pontos:', data);
        setCarregando('resultadoCliente', 'verificarBtn', false);
        if (data.error) {
          document.getElementById("resultadoCliente").innerText = sanitizarTexto(data.error);
        } else {
          document.getElementById("resultadoCliente").innerText = `Você tem ${sanitizarTexto(data.pontos.toString())} pontos.`;
        }
      } catch (error) {
        console.error('Erro ao verificar pontos:', error);
        setCarregando('resultadoCliente', 'verificarBtn', false);
        document.getElementById("resultadoCliente").innerText = "Erro ao verificar pontos.";
      }
    }

    // Adicionar pontos
    async function adicionarPontos() {
      const senha = document.getElementById("senhaLojista").value;
      const clienteId = document.getElementById("clienteIdLojista").value.trim();
      const pontos = parseInt(document.getElementById("pontos").value);

      setCarregando('resultadoLojista', 'adicionarBtn', true);

      try {
        console.log('Enviando requisição para /adicionar-pontos');
        const response = await fetch('/adicionar-pontos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ senha, clienteId, pontos })
        });
        const data = await response.json();
        console.log('Resposta de /adicionar-pontos:', data);
        setCarregando('resultadoLojista', 'adicionarBtn', false);
        document.getElementById("resultadoLojista").innerText = sanitizarTexto(data.message || data.error);
      } catch (error) {
        console.error('Erro ao adicionar pontos:', error);
        setCarregando('resultadoLojista', 'adicionarBtn', false);
        document.getElementById("resultadoLojista").innerText = "Erro ao adicionar pontos.";
      }
    }

    // Resgatar recompensa
    async function resgatarRecompensa() {
      const senha = document.getElementById("senhaLojista").value;
      const clienteId = document.getElementById("clienteIdLojista").value.trim();

      setCarregando('resultadoLojista', 'resgatarBtn', true);

      try {
        console.log('Enviando requisição para /resgatar-recompensa');
        const response = await fetch('/resgatar-recompensa', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ senha, clienteId })
        });
        const data = await response.json();
        console.log('Resposta de /resgatar-recompensa:', data);
        setCarregando('resultadoLojista', 'resgatarBtn', false);
        document.getElementById("resultadoLojista").innerText = sanitizarTexto(data.message || data.error);
      } catch (error) {
        console.error('Erro ao resgatar recompensa:', error);
        setCarregando('resultadoLojista', 'resgatarBtn', false);
        document.getElementById("resultadoLojista").innerText = "Erro ao resgatar recompensa.";
      }
    }
  </script>
</body>
</html>